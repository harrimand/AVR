; M2560 Final Practice

.nolist
.include "m2560def.inc"
.list

.def	TEMP = R16
.def	TEMPH = R17
.def	PJold = R18
.def	PCbit = R19  ; Pin Change Bit
.def	FunR0 = R12
.def	FunR1 = R13
.def	FunR2 = R14
.def	FunR3 = R15
.def	ZERO = R5

.ORG	$0000
		rjmp	RESET
.ORG	PCI1addr
		rjmp	PinChange2


RESET:
		ldi 	TEMP, high(RAMEND)
		out 	SPH, TEMP
		ldi 	TEMP, low(RAMEND)
		out 	SPL, TEMP

		ldi 	TEMP, (1<<PCINT12)|(1<<PCINT11)|(1<<PCINT10)|(1<<PCINT9)
		sts 	PCMSK1, TEMP

		clr 	TEMP
		sts 	DDRJ, TEMP

		ldi 	TEMP, (1<<PJ3)|(1<<PJ2)|(1<<PJ1)|(1<<PJ0)
		sts 	PORTJ, TEMP

		ldi 	TEMP, (1<<PCIE1)
		sts 	PCICR, TEMP

		clr 	PCbit
		clr 	ZERO

		lds 	PJold, PINJ
		andi	PJold, $0F

		sei

MAIN:
		nop
		nop
		sbis	GPIOR0, 7
		rjmp	NoFun
		ldi 	ZH, high(FunAddress)
		ldi 	ZL, low(FunAddress)
		add 	ZL, PCbit
		adc 	ZH, ZERO
		lsl 	ZL
		lpm 	TEMP, Z+
		lpm 	TEMPH, Z
		mov 	ZL, TEMP
		mov 	ZH, TEMPH
		icall		
		cbi 	GPIOR0, 7		
NoFun:
		nop
		rjmp	MAIN

PinChange2:
		push	TEMP
		lds  	TEMP, PINJ
		andi	TEMP, 0x0F
		eor 	TEMP, PJold
		lds 	PJold, PINJ
		tst 	TEMP
		breq	ZeroEscape
		clr 	PCbit
FindBit:
		inc 	PCbit
		lsr 	TEMP
		brcc	FindBit
		dec 	PCbit
		sbi 	GPIOR0, 7

ZeroEscape:
		pop 	TEMP
		reti

Fun0:
		inc 	FunR0
		ret
Fun1:
		inc 	FunR1
		ret
Fun2:
		inc 	FunR2
		ret
Fun3:
		inc 	FunR3
		ret

FunAddress:
.dw 	Fun0, Fun1, Fun2, Fun3

